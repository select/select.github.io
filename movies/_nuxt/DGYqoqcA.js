import{a as K}from"./DoKBSrbM.js";import{E as P,a9 as Q,e as m,r as h,ak as U,H as B,k as q,N as A,n as X,a1 as H,c as v,J as C,z as n,V as E,K as F,L as T,T as Z,o as c,O as ee,F as te,Q as oe,Y as se}from"./Ck9VlGs8.js";import{u as ae}from"./CrqnEE15.js";const M=3,ne=P({__name:"MovieVirtualGrid",props:{movies:{},totalMovies:{}},emits:["load-more"],setup(L,{emit:G}){const u=L,N=G,{y:_}=Q(),{height:R,width:O}=Z(),i=oe(se),r=m(()=>i.xl.value?6:i.lg.value?5:i.md.value?4:i.sm.value?3:2),D=m(()=>i.xl.value?"grid-cols-6":i.lg.value?"grid-cols-5":i.md.value?"grid-cols-4":i.sm.value?"grid-cols-3":"grid-cols-2"),x=h(null),{height:y}=U(x),d=m(()=>{if(y.value>0)return y.value+16;const t=O.value||1024,e=i.lg.value?t*.12:32,s=t-e,a=(r.value-1)*16,g=(s-a)/r.value*1.5;return Math.ceil(g+80+16)}),k=m(()=>Math.ceil(u.movies.length/r.value)),Y=m(()=>k.value*d.value),I=h(0),f=h(null),p=()=>{if(f.value){const t=f.value.getBoundingClientRect();I.value=t.top+window.scrollY}};B(()=>{p(),window.addEventListener("resize",p)}),q(()=>{window.removeEventListener("resize",p)});const w=()=>{if(!u.movies||u.movies.length===0)return[];const t=Math.max(0,_.value-I.value),e=Math.max(0,Math.floor(t/d.value)-M),s=Math.min(k.value-1,Math.ceil((t+R.value)/d.value)+M),l=[];for(let a=e;a<=s;a++){const b=a*r.value,g=u.movies.slice(b,b+r.value);g.length>0&&l.push({index:a,top:a*d.value,movies:g})}return l},o=h(w()),V=ae(),{fetchMoviesByIds:$}=V,{movieDetailsCache:S}=A(V),W=h(new Set),j=t=>{const e=S.value.get(t.imdbId);return e&&e.title?{imdbId:e.imdbId,title:e.title,year:e.year,imdbRating:e.metadata?.imdbRating,imdbVotes:e.metadata?.imdbVotes,language:e.metadata?.Language,sourceType:e.sources?.[0]?.type,channelName:e.sources?.[0]?.type==="youtube"?e.sources[0].channelName:void 0,verified:e.verified}:t},z=H(t=>{const e=t.filter(s=>!S.value.has(s)&&!W.value.has(s));e.length>0&&(console.log("[MovieVirtualGrid] Fetching",e.length,"uncached movies"),e.forEach(s=>W.value.add(s)),$(e))},300),J=H(()=>{o.value=w();const t=Math.ceil(u.movies.length/r.value),e=o.value[o.value.length-1];e&&e.index>=t-M-1&&N("load-more");const s=o.value.flatMap(l=>l.movies.map(a=>a.imdbId)).filter(Boolean);s.length>0&&z(s)},80);return X([_,R,d,r,()=>u.movies.length],()=>{J()}),B(()=>{o.value=w();const t=o.value.flatMap(e=>e.movies.map(s=>s.imdbId)).filter(Boolean);t.length>0&&z(t)}),(t,e)=>{const s=K;return c(),v("div",{ref_key:"gridRef",ref:f,class:"w-full"},[n(o).length>0&&n(o)[0]&&n(o)[0].index>0?(c(),v("div",{key:0,style:E({height:`${n(o)[0].top}px`})},null,4)):C("",!0),(c(!0),v(F,null,T(n(o),l=>(c(),v("div",{key:l.index,ref_for:!0,ref:l.index===0?a=>x.value=a:void 0,class:ee(["grid gap-4 mb-4",n(D)])},[(c(!0),v(F,null,T(l.movies,a=>(c(),te(s,{key:a.imdbId,movie:j(a)},null,8,["movie"]))),128))],2))),128)),n(o).length>0&&n(o)[n(o).length-1]?(c(),v("div",{key:1,style:E({height:`${n(Y)-(n(o)[n(o).length-1].top+n(d))}px`})},null,4)):C("",!0)],512)}}}),de=Object.assign(ne,{__name:"MovieVirtualGrid"});export{de as _};
