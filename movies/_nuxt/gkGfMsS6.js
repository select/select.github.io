import{O as Se,a3 as U,S as _,m as I,f as R,ad as Me,p as P,ae as S,af as Ie}from"./Cvy9wTBJ.js";import{u as Re}from"./BHXQHDgZ.js";const A=[{field:"relevance",direction:"desc",label:"Relevance"},{field:"year",direction:"desc",label:"Year (Newest)"},{field:"year",direction:"asc",label:"Year (Oldest)"},{field:"rating",direction:"desc",label:"Rating (High)"},{field:"rating",direction:"asc",label:"Rating (Low)"},{field:"title",direction:"asc",label:"Title (A-Z)"},{field:"title",direction:"desc",label:"Title (Z-A)"},{field:"votes",direction:"desc",label:"Most Popular"}];function Ce(n,l){return[...n].sort((d,t)=>{const u=d.year||0,f=t.year||0;if(u===0&&f===0)return 0;if(u===0)return 1;if(f===0)return-1;if(u===f){const v=d.title,c=t.title,h=v.localeCompare(c);if(h!==0)return h;const g=d.imdbId||"",y=t.imdbId||"";return g.localeCompare(y)}return l==="asc"?u-f:f-u})}function Ae(n,l){return[...n].sort((d,t)=>{const u=parseFloat(d.metadata?.imdbRating||"0"),f=parseFloat(t.metadata?.imdbRating||"0");if(u===0&&f===0)return 0;if(u===0)return 1;if(f===0)return-1;if(u===f){const v=d.title,c=t.title,h=v.localeCompare(c);if(h!==0)return h;const g=d.imdbId||"",y=t.imdbId||"";return g.localeCompare(y)}return l==="asc"?u-f:f-u})}function Le(n,l){return[...n].sort((d,t)=>{const u=d.title.toLowerCase(),f=t.title.toLowerCase(),v=u.localeCompare(f);if(v!==0)return l==="asc"?v:-v;const c=d.imdbId||"",h=t.imdbId||"";return c.localeCompare(h)})}function Be(n,l){return[...n].sort((d,t)=>{const u=d.metadata?.imdbVotes,f=t.metadata?.imdbVotes,v=typeof u=="number"?u:parseInt(String(u||"0").replace(/,/g,"")),c=typeof f=="number"?f:parseInt(String(f||"0").replace(/,/g,""));if(v===0&&c===0)return 0;if(v===0)return 1;if(c===0)return-1;if(v===c){const h=d.title,g=t.title,y=h.localeCompare(g);if(y!==0)return y;const F=d.imdbId||"",$=t.imdbId||"";return F.localeCompare($)}return l==="asc"?v-c:c-v})}function De(n,l){switch(l.field){case"year":return Ce(n,l.direction);case"rating":return Ae(n,l.direction);case"title":return Le(n,l.direction);case"votes":return Be(n,l.direction);default:return n}}const x={sort:{field:"year",direction:"desc"},sources:[],minRating:0,minYear:0,minVotes:0,genres:[],countries:[],searchQuery:"",currentPage:1,lastScrollY:0},Ee=Se("movie",()=>{const n=U(new Map),l=U(new Map),d=_("movies-deluxe-liked",[]),t=_("movies-deluxe-filters",x),u=I({movies:!1,movieDetails:!1,imdbFetch:!1}),f=I(!0),v=I(!1),c=Re(),h=I(new Map),g=I([]),y=I([]),F=R(()=>g.value.length>0?g.value:Array.from(n.value.values()).filter(e=>e.year!==void 0).sort((e,r)=>(r.year||0)-(e.year||0)).map(e=>({imdbId:e.imdbId,title:e.title,year:e.year||0}))),$=R(()=>n.value.size),L=I(0),H=R(()=>d.value.length),W=R(()=>{let e=0;return t.value.sources.length>0&&e++,t.value.minRating>0&&e++,t.value.minYear>0&&e++,t.value.minVotes>0&&e++,t.value.genres.length>0&&e++,t.value.countries.length>0&&e++,e}),J=R(()=>t.value.sources.length>0||t.value.minRating>0||t.value.minYear>0||t.value.minVotes>0||t.value.genres.length>0||t.value.countries.length>0),z=R(()=>{if(!t.value||!t.value.sort)return A[0];const e=t.value.sort;return A.find(i=>i.field===e.field&&i.direction===e.direction)||A[0]}),G=e=>({imdbId:e.imdbId,title:e.title,year:e.year,lastUpdated:new Date().toISOString(),sources:[],metadata:{imdbRating:typeof e.imdbRating=="number"?e.imdbRating.toString():e.imdbRating?.toString(),imdbVotes:typeof e.imdbVotes=="number"?e.imdbVotes.toLocaleString():e.imdbVotes?.toString(),imdbID:e.imdbId,Language:e.language}}),Q=e=>({imdbId:e.imdbId,title:e.title,year:e.year,lastUpdated:e.lastUpdated,sources:[],metadata:{imdbRating:e.imdbRating?.toString(),imdbVotes:e.imdbVotes?.toLocaleString(),imdbID:e.imdbId,Genre:e.genre,Language:e.language,Country:e.country},verified:e.verified}),K=async()=>{u.value.movies=!0;try{const r=Ie().app.baseURL||"/",i=r==="/"?"/data/movies.db":`${r}data/movies.db`;await c.init(i),f.value=!1}catch(e){window.console.error("Failed to initialize SQLite:",e),await O()}finally{u.value.movies=!1,f.value=!1}},O=async()=>{u.value.movies=!0;try{const e=await $fetch("/api/movies");if(e.error){window.console.error("Failed to load movies from JSON:",e.message);return}const r=Object.entries(e).filter(([i])=>!i.startsWith("_")).filter(([,i])=>{if(!i||typeof i!="object"||!("imdbId"in i)||!("title"in i))return!1;const a=i;return typeof a.imdbId!="string"?!1:typeof a.title=="string"?!0:Array.isArray(a.title)?a.title.every(s=>typeof s=="string"):!1}).map(([,i])=>i);n.value.clear(),r.forEach(i=>{n.value.set(i.imdbId,i)})}catch(e){window.console.error("Failed to load movies from JSON fallback:",e)}finally{u.value.movies=!1,f.value=!1}},N=async e=>{if(!c.isReady.value)return{result:[],totalCount:0};const{searchQuery:r,where:i,params:a=[],orderBy:s,limit:o,offset:p,includeCount:w}=e;let b=i||"";const M=[...a];if(r?.trim()){const C="EXISTS (SELECT 1 FROM fts_movies f WHERE f.imdbId = m.imdbId AND fts_movies MATCH ?)";b=b?`(${b}) AND (${C})`:C;const V=r.replace(/"/g,'""').trim();M.push(`"${V}"`)}const{result:D,totalCount:m}=await c.lightweightQuery({where:b,params:M,orderBy:s||"m.year DESC, m.imdbId",limit:o,offset:p,includeCount:w});return{result:D.map(G),totalCount:m||0}},Y=async e=>{if(!c.isReady.value)return[];if(!e||e.length===0)return[];l.value||(l.value=new Map);const r=e.filter(i=>!l.value.has(i));if(r.length===0)return e.map(i=>l.value.get(i)).filter(Boolean);console.log("[MovieStore] Fetching details for",r.length,"uncached movies");try{return(await c.queryByIds(r)).map(Q).forEach(s=>{l.value.set(s.imdbId,s),n.value.has(s.imdbId)||n.value.set(s.imdbId,s)}),e.map(s=>l.value.get(s)).filter(Boolean)}catch(i){return window.console.error("[MovieStore] Failed to fetch movies by IDs:",i),[]}},Z=async e=>{if(l.value.has(e)){const r=l.value.get(e);if(r&&r.sources&&r.sources.length>0)return r}if(n.value.has(e)){const r=n.value.get(e);if(r&&r.sources&&r.sources.length>0)return r}u.value.movieDetails=!0;try{const r=await $fetch(`/movies/${e}.json`);if(r&&typeof r=="object"&&r.imdbId&&r.title)return l.value.set(e,r),r;console.warn(`[MovieStore] Invalid movie data for ${e}`);return}catch(r){window.console.error(`[MovieStore] Failed to fetch movie details for ${e}:`,r);return}finally{u.value.movieDetails=!1}},X=async(e,r=8)=>{try{const i=await $fetch(`/movies/${e}.json`);if(!i||!i.relatedMovies||i.relatedMovies.length===0)return[];if(c.isReady.value){const a=i.relatedMovies.map(o=>o.imdbId);return await Y(a)}return i.relatedMovies.map(a=>({imdbId:a.imdbId,title:a.title,year:a.year,sources:[],lastUpdated:new Date().toISOString(),metadata:{imdbRating:a.imdbRating?.toString(),imdbVotes:a.imdbVotes?.toString(),Language:a.language}}))}catch(i){return window.console.error("[MovieStore] Failed to fetch related movies:",i),[]}},q=async e=>{if(!e||!e.trim())return Array.from(n.value.values());if(!c.isReady.value){const r=e.toLowerCase();return Array.from(n.value.values()).filter(i=>(Array.isArray(i.title)?i.title:[i.title]).some(s=>s.toLowerCase().includes(r)))}try{const r=e.replace(/"/g,'""').trim(),i=await c.query(`
        SELECT m.imdbId
        FROM fts_movies f
        JOIN movies m ON f.imdbId = m.imdbId
        WHERE fts_movies MATCH ?
        ORDER BY m.title ASC
      `,[`"${r}"`]),a=new Set(i.map(s=>s.imdbId));return Array.from(n.value.values()).filter(s=>a.has(s.imdbId))}catch(r){return window.console.error("[MovieStore] Search failed:",r),[]}},E=async()=>{if(!c.isReady.value){window.console.log("DB not ready, cannot fetch lightweight movies");return}v.value=!0;try{const e=[],r=[];if(t.value.minRating>0&&(r.push("m.imdbRating >= ?"),e.push(t.value.minRating)),t.value.minYear>0&&(r.push("m.year >= ?"),e.push(t.value.minYear)),t.value.minVotes>0&&(r.push("m.imdbVotes >= ?"),e.push(t.value.minVotes)),t.value.genres.length>0&&t.value.genres.forEach(w=>{r.push("m.genre LIKE ?"),e.push(`%${w}%`)}),t.value.countries.length>0&&t.value.countries.forEach(w=>{r.push("m.country LIKE ?"),e.push(`%${w}%`)}),t.value.sources.length>0){await B();return}let i="";const a=t.value.sort.field,s=t.value.sort.direction.toUpperCase();if(a==="relevance"&&t.value.searchQuery){await B();return}else a==="rating"?i=`m.imdbRating ${s}`:a==="year"?i=`m.year ${s}`:a==="title"?i=`m.title ${s}`:a==="votes"&&(i=`m.imdbVotes ${s}`);const{result:o,totalCount:p}=await c.lightweightQuery({where:r.join(" AND "),params:e,orderBy:i,includeCount:!0});g.value=o||[],p!==void 0&&(L.value=p)}catch(e){window.window.console.error("[MovieStore] Lightweight query failed:",e),g.value=[]}finally{v.value=!1}},B=async(e=!1)=>{if(!c.isReady.value){window.window.console.error("DB not ready, using JS filtering");const r=await q(t.value.searchQuery);y.value=T(r),L.value=y.value.length;return}e||(v.value=!0);try{const r=[],i=[];if(t.value.minRating>0&&(i.push("m.imdbRating >= ?"),r.push(t.value.minRating)),t.value.minYear>0&&(i.push("m.year >= ?"),r.push(t.value.minYear)),t.value.minVotes>0&&(i.push("m.imdbVotes >= ?"),r.push(t.value.minVotes)),t.value.sources.length>0){const m=[];t.value.sources.includes("archive.org")&&m.push("s.type = 'archive.org'");const C=t.value.sources.filter(V=>V!=="archive.org");C.length>0&&(m.push(`(s.type = 'youtube' AND c.name IN (${C.map(()=>"?").join(",")}))`),r.push(...C)),m.length>0&&i.push(`(${m.join(" OR ")})`)}t.value.genres.length>0&&t.value.genres.forEach(m=>{i.push("m.genre LIKE ?"),r.push(`%${m}%`)}),t.value.countries.length>0&&t.value.countries.forEach(m=>{i.push("m.country LIKE ?"),r.push(`%${m}%`)});let a="";const s=t.value.sort.field,o=t.value.sort.direction.toUpperCase();s==="relevance"&&t.value.searchQuery?a=`m.title ${o}`:s==="rating"?a=`m.imdbRating ${o}`:s==="year"?a=`m.year ${o}`:s==="title"?a=`m.title ${o}`:s==="votes"&&(a=`m.imdbVotes ${o}`);const p=50,w=t.value.currentPage*p,b=e?(t.value.currentPage-1)*p:0,{result:M,totalCount:D}=await N({searchQuery:t.value.searchQuery,where:i.join(" AND "),params:r,orderBy:a,limit:e?p:w,offset:b,includeCount:!0});e?(y.value=[...y.value,...M],g.value=[...g.value,...M.map(m=>({imdbId:m.imdbId,title:m.title,year:m.year||0}))]):(y.value=M,g.value=M.map(m=>({imdbId:m.imdbId,title:m.title,year:m.year||0}))),D!==void 0&&(L.value=D)}catch(r){window.window.console.error("[MovieStore] SQL filtering failed:",r),y.value=[]}finally{v.value=!1}},T=e=>{let r=[...e];r=j(r),t.value.sources.length>0&&(r=r.filter(a=>a.sources.some(s=>s.type==="archive.org"?t.value.sources.includes("archive.org"):s.type==="youtube"?t.value.sources.includes(s.channelName):!1))),t.value.minRating>0&&(r=r.filter(a=>parseFloat(a.metadata?.imdbRating||"0")>=t.value.minRating)),t.value.minYear>0&&(r=r.filter(a=>(a.year||0)>=t.value.minYear)),t.value.minVotes>0&&(r=r.filter(a=>{const s=a.metadata?.imdbVotes;return(typeof s=="number"?s:parseInt(String(s||"0").replace(/,/g,"")))>=t.value.minVotes})),t.value.genres.length>0&&(r=r.filter(a=>{const s=a.metadata?.Genre?.split(", ").map(o=>o.trim())||[];return t.value.genres.some(o=>s.includes(o))})),t.value.countries.length>0&&(r=r.filter(a=>{const s=a.metadata?.Country?.split(", ").map(o=>o.trim())||[];return t.value.countries.some(o=>s.includes(o))}));const i=A.find(a=>a.field===t.value.sort.field&&a.direction===t.value.sort.direction)||A[0];return i.field!=="relevance"&&(r=De(r,i)),r},ee=e=>{t.value.sort={field:e.field,direction:e.direction},t.value.searchQuery!==""&&(t.value.previousSort=void 0)},te=e=>{const r=t.value.searchQuery==="",i=e==="";r&&!i?(t.value.previousSort={...t.value.sort},t.value.sort={field:"relevance",direction:"desc"}):!r&&i&&t.value.previousSort&&(t.value.sort={...t.value.previousSort},t.value.previousSort=void 0),t.value.searchQuery=e},re=e=>{t.value.sources=t.value.sources.includes(e)?t.value.sources.filter(r=>r!==e):[...t.value.sources,e]},ie=e=>{t.value.minRating=e},ae=e=>{t.value.minYear=e},se=e=>{t.value.minVotes=e},oe=e=>{t.value.genres=t.value.genres.includes(e)?t.value.genres.filter(r=>r!==e):[...t.value.genres,e]},ne=e=>{t.value.countries=t.value.countries.includes(e)?t.value.countries.filter(r=>r!==e):[...t.value.countries,e]},le=()=>{t.value={...x}},ue=e=>{t.value.currentPage=e},ce=e=>{t.value.lastScrollY=e},de=e=>{const r=d.value.indexOf(e);r>-1?d.value.splice(r,1):d.value.push(e)},fe=e=>{d.value.includes(e)||d.value.push(e)},ve=e=>d.value.includes(e),me=e=>{if(e.sources.length===0)return;const r=e.sources.filter(i=>i.type==="archive.org");return r.length>0?[...r].sort((a,s)=>{const o="downloads"in a&&a.downloads||0;return("downloads"in s&&s.downloads||0)-o})[0]:e.sources[0]},k=async e=>{if(!e)return!1;if(h.value.has(e))return h.value.get(e);try{const i=(await fetch(`/posters/${e}.jpg`,{method:"HEAD"})).ok;return h.value.set(e,i),i}catch{return h.value.set(e,!1),!1}},ge=async e=>{const r="/images/poster-placeholder.jpg";if(!e.imdbId)return r;if(await k(e.imdbId))return`/posters/${e.imdbId}.jpg`;const a=e.metadata?.Poster;return a&&a!=="N/A"?a:r},he=(e,r=!0)=>{const i="/images/poster-placeholder.jpg";if(!e.imdbId)return i;if(r)return`/posters/${e.imdbId}.jpg`;const a=e.metadata?.Poster;return a&&a!=="N/A"?a:i},ye=async(e,r,i,a="admin")=>{try{if((await $fetch("/api/admin/movie/update",{method:"POST",body:{movieId:e,qualityLabels:r,qualityNotes:i,qualityMarkedBy:a}})).success){const o=b=>{b.qualityLabels=r,b.qualityNotes=i,b.qualityMarkedBy=a,b.qualityMarkedAt=new Date().toISOString(),b.lastUpdated=new Date().toISOString()},p=n.value.get(e);p&&o(p);const w=l.value.get(e);return w&&o(w),!0}return!1}catch(s){return window.console.error("[MovieStore] Failed to mark movie quality:",s),!1}},pe=async e=>{try{if((await $fetch("/api/admin/movie/update",{method:"POST",body:{movieId:e,qualityLabels:[]}})).success){const i=o=>{delete o.qualityLabels,delete o.qualityNotes,delete o.qualityMarkedBy,delete o.qualityMarkedAt,o.lastUpdated=new Date().toISOString()},a=n.value.get(e);a&&i(a);const s=l.value.get(e);return s&&i(s),!0}return!1}catch(r){return window.console.error("[MovieStore] Failed to clear movie quality:",r),!1}},be=()=>Array.from(n.value.values()).filter(e=>(e.qualityLabels?.length||0)>0),j=e=>e.filter(r=>(r.qualityLabels?.length||0)===0),we=Me(R(()=>t.value.searchQuery),500);return P(()=>{const{currentPage:e,lastScrollY:r,searchQuery:i,...a}=t.value;return JSON.stringify({...a,searchQuery:we.value})},()=>{t.value.currentPage=1,E()}),P(()=>t.value.currentPage,(e,r)=>{e>r&&B(!0)}),P(()=>c.isReady.value,e=>{console.log("[MovieStore] Watch triggered - DB ready:",e);const r=g.value?.length||0;console.log("[MovieStore] lightweightMovies.value.length:",r),e&&r===0&&(console.log("[MovieStore] DB is ready, fetching lightweight movies..."),E())},{immediate:!0}),{allMovies:S(n),movieDetailsCache:S(l),filters:S(t),isInitialLoading:S(f),isFiltering:S(v),isLoading:S(u),likedMovieIds:S(d),filteredAndSortedMovies:S(y),lightweightMovies:S(g),currentMovieList:F,totalMovies:$,totalFiltered:S(L),likedCount:H,activeFiltersCount:W,hasActiveFilters:J,currentSortOption:z,loadFromFile:K,loadFromApi:O,fetchMovies:N,fetchMoviesByIds:Y,getMovieById:Z,getRelatedMovies:X,searchMovies:q,mapRowToMovie:Q,setSort:ee,setSearchQuery:te,toggleSource:re,setMinRating:ie,setMinYear:ae,setMinVotes:se,toggleGenre:oe,toggleCountry:ne,resetFilters:le,applyFilters:T,fetchFilteredMovies:B,fetchLightweightMovies:E,setCurrentPage:ue,setScrollY:ce,toggleLike:de,like:fe,isLiked:ve,getPrimarySource:me,posterExists:k,getPosterUrl:ge,getPosterUrlSync:he,markMovieQuality:ye,clearMovieQuality:pe,getMarkedMovies:be,getQualityFilteredMovies:j}});export{Ee as u};
