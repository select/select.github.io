import{a as K}from"./C_3uOQ0x.js";import{E as P,r as m,a9 as Q,e as h,H as S,k as U,N as q,n as A,a1 as V,c as d,J as z,z as i,V as H,K as F,L as T,T as X,o as c,O as Z,F as ee,Q as te,Y as oe}from"./C1DehbHX.js";import{u as ne}from"./BPf94GNk.js";const b=3,se=P({__name:"MovieVirtualGrid",props:{movies:{},columnCount:{}},emits:["load-more"],setup(E,{emit:L}){const l=E,G=L,f=m(null),p=m(null),v=te(oe),{y:x}=Q(),{height:R,width:O}=X(),r=h(()=>l.columnCount?l.columnCount:v.xl.value?6:v.lg.value?5:v.md.value?4:v.sm.value?3:2),D=h(()=>l.columnCount?`grid-cols-${l.columnCount}`:"grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6"),u=h(()=>{if(p.value)return p.value.getBoundingClientRect().height+16;const e=O.value||1024,t=v.lg.value?e*.12:32,n=e-t,s=(r.value-1)*16,g=(n-s)/r.value*1.5;return Math.ceil(g+80+16)}),C=h(()=>Math.ceil(l.movies.length/r.value)),Y=h(()=>C.value*u.value),k=m(0),w=()=>{if(f.value){const e=f.value.getBoundingClientRect();k.value=e.top+window.scrollY}};S(()=>{w(),window.addEventListener("resize",w)}),U(()=>{window.removeEventListener("resize",w)});const M=()=>{if(!l.movies||l.movies.length===0)return[];const e=Math.max(0,x.value-k.value),t=Math.max(0,Math.floor(e/u.value)-b),n=Math.min(C.value-1,Math.ceil((e+R.value)/u.value)+b),a=[];for(let s=t;s<=n;s++){const _=s*r.value,g=l.movies.slice(_,_+r.value);g.length>0&&a.push({index:s,top:s*u.value,movies:g})}return a},o=m(M()),y=ne(),{fetchMoviesByIds:$,mapMovieToLightweight:N}=y,{movieDetailsCache:I}=q(y),B=m(new Set),j=e=>{const t=I.value.get(e.imdbId);return t&&t.title?N(t):e},W=V(e=>{const t=e.filter(n=>!I.value.has(n)&&!B.value.has(n));t.length>0&&(console.log("[MovieVirtualGrid] Fetching",t.length,"uncached movies"),t.forEach(n=>B.value.add(n)),$(t))},300),J=V(()=>{o.value=M();const e=Math.ceil(l.movies.length/r.value),t=o.value[o.value.length-1];t&&t.index>=e-b-1&&G("load-more");const n=o.value.flatMap(a=>a.movies.map(s=>s.imdbId)).filter(Boolean);n.length>0&&W(n)},80);return A([x,R,u,r,()=>l.movies.length],()=>{J()}),S(()=>{o.value=M();const e=o.value.flatMap(t=>t.movies.map(n=>n.imdbId)).filter(Boolean);e.length>0&&W(e)}),(e,t)=>{const n=K;return c(),d("div",{ref_key:"gridRef",ref:f,class:"w-full"},[i(o).length>0&&i(o)[0]&&i(o)[0].index>0?(c(),d("div",{key:0,style:H({height:`${i(o)[0].top}px`})},null,4)):z("",!0),(c(!0),d(F,null,T(i(o),a=>(c(),d("div",{key:a.index,ref_for:!0,ref:a.index===0?s=>p.value=s:void 0,class:Z(["grid gap-4 mb-4",i(D)])},[(c(!0),d(F,null,T(a.movies,s=>(c(),ee(n,{key:s.imdbId,movie:j(s)},null,8,["movie"]))),128))],2))),128)),i(o).length>0&&i(o)[i(o).length-1]?(c(),d("div",{key:1,style:H({height:`${i(Y)-(i(o)[i(o).length-1].top+i(u))}px`})},null,4)):z("",!0)],512)}}}),de=Object.assign(se,{__name:"MovieVirtualGrid"});export{de as _};
