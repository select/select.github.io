import{O as Ce,a6 as _,S as H,m as I,f as R,ae as Ve,p as $,af as S,ag as E}from"./CgEeLIgt.js";import{u as Ae,g as P}from"./BgE6LmUp.js";const V=[{field:"relevance",direction:"desc",label:"Relevance"},{field:"year",direction:"desc",label:"Year (Newest)"},{field:"year",direction:"asc",label:"Year (Oldest)"},{field:"rating",direction:"desc",label:"Rating (High)"},{field:"rating",direction:"asc",label:"Rating (Low)"},{field:"title",direction:"asc",label:"Title (A-Z)"},{field:"title",direction:"desc",label:"Title (Z-A)"},{field:"votes",direction:"desc",label:"Most Popular"}];function Le(l,n){return[...l].sort((d,t)=>{const u=d.year||0,v=t.year||0;if(u===0&&v===0)return 0;if(u===0)return 1;if(v===0)return-1;if(u===v){const f=d.title,c=t.title,h=f.localeCompare(c);if(h!==0)return h;const g=d.imdbId||"",y=t.imdbId||"";return g.localeCompare(y)}return n==="asc"?u-v:v-u})}function xe(l,n){return[...l].sort((d,t)=>{const u=parseFloat(d.metadata?.imdbRating||"0"),v=parseFloat(t.metadata?.imdbRating||"0");if(u===0&&v===0)return 0;if(u===0)return 1;if(v===0)return-1;if(u===v){const f=d.title,c=t.title,h=f.localeCompare(c);if(h!==0)return h;const g=d.imdbId||"",y=t.imdbId||"";return g.localeCompare(y)}return n==="asc"?u-v:v-u})}function Ye(l,n){return[...l].sort((d,t)=>{const u=d.title.toLowerCase(),v=t.title.toLowerCase(),f=u.localeCompare(v);if(f!==0)return n==="asc"?f:-f;const c=d.imdbId||"",h=t.imdbId||"";return c.localeCompare(h)})}function Fe(l,n){return[...l].sort((d,t)=>{const u=d.metadata?.imdbVotes,v=t.metadata?.imdbVotes,f=typeof u=="number"?u:parseInt(String(u||"0").replace(/,/g,"")),c=typeof v=="number"?v:parseInt(String(v||"0").replace(/,/g,""));if(f===0&&c===0)return 0;if(f===0)return 1;if(c===0)return-1;if(f===c){const h=d.title,g=t.title,y=h.localeCompare(g);if(y!==0)return y;const Y=d.imdbId||"",F=t.imdbId||"";return Y.localeCompare(F)}return n==="asc"?f-c:c-f})}function Be(l,n){switch(n.field){case"year":return Le(l,n.direction);case"rating":return xe(l,n.direction);case"title":return Ye(l,n.direction);case"votes":return Fe(l,n.direction);default:return l}}const J={sort:{field:"year",direction:"desc"},sources:[],minRating:0,minYear:0,maxYear:0,minVotes:0,maxVotes:0,genres:[],countries:[],searchQuery:"",currentPage:1,lastScrollY:0},Ee=Ce("movie",()=>{const l=_(new Map),n=_(new Map),d=H("movies-deluxe-liked",[]),t=H("movies-deluxe-filters",J),u=I({movies:!1,movieDetails:!1,imdbFetch:!1}),v=I(!0),f=I(!1),c=Ae(),h=I(new Map),g=I([]),y=I([]),Y=R(()=>g.value.length>0?g.value:Array.from(l.value.values()).filter(e=>e.year!==void 0).sort((e,a)=>(a.year||0)-(e.year||0)).map(e=>({imdbId:e.imdbId,title:e.title,year:e.year||0}))),F=R(()=>l.value.size),A=I(0),W=R(()=>d.value.length),z=R(()=>{let e=0;return t.value.sources.length>0&&e++,t.value.minRating>0&&e++,t.value.minYear>0&&e++,t.value.minVotes>0&&e++,t.value.genres.length>0&&e++,t.value.countries.length>0&&e++,e}),G=R(()=>t.value.sources.length>0||t.value.minRating>0||t.value.minYear>0||t.value.minVotes>0||t.value.genres.length>0||t.value.countries.length>0),K=R(()=>{if(!t.value||!t.value.sort)return V[0];const e=t.value.sort;return V.find(r=>r.field===e.field&&r.direction===e.direction)||V[0]}),Z=e=>({imdbId:e.imdbId,title:e.title,year:e.year,lastUpdated:new Date().toISOString(),sources:[],metadata:{imdbRating:typeof e.imdbRating=="number"?e.imdbRating.toString():e.imdbRating?.toString(),imdbVotes:typeof e.imdbVotes=="number"?e.imdbVotes.toLocaleString():e.imdbVotes?.toString(),imdbID:e.imdbId,Language:e.language}}),Q=e=>({imdbId:e.imdbId,title:e.title,year:e.year,lastUpdated:e.lastUpdated,sources:[],metadata:{imdbRating:e.imdbRating?.toString(),imdbVotes:e.imdbVotes?.toLocaleString(),imdbID:e.imdbId,Genre:e.genre,Language:e.language,Country:e.country},verified:e.verified}),X=async()=>{u.value.movies=!0;try{await c.init(`${E().app.baseURL}data/movies.db`),v.value=!1}catch(e){window.console.error("Failed to initialize SQLite:",e),await O()}finally{u.value.movies=!1,v.value=!1}},O=async()=>{u.value.movies=!0;try{const e=await $fetch("/api/movies");if(e.error){window.console.error("Failed to load movies from JSON:",e.message);return}const a=Object.entries(e).filter(([r])=>!r.startsWith("_")).filter(([,r])=>{if(!r||typeof r!="object"||!("imdbId"in r)||!("title"in r))return!1;const i=r;return typeof i.imdbId!="string"?!1:typeof i.title=="string"?!0:Array.isArray(i.title)?i.title.every(s=>typeof s=="string"):!1}).map(([,r])=>r);l.value.clear(),a.forEach(r=>{l.value.set(r.imdbId,r)})}catch(e){window.console.error("Failed to load movies from JSON fallback:",e)}finally{u.value.movies=!1,v.value=!1}},N=async e=>{if(!c.isReady.value)return{result:[],totalCount:0};const{searchQuery:a,where:r,params:i=[],orderBy:s,limit:o,offset:p,includeCount:w}=e;let b=r||"";const M=[...i];if(a?.trim()){const C="EXISTS (SELECT 1 FROM fts_movies f WHERE f.imdbId = m.imdbId AND fts_movies MATCH ?)";b=b?`(${b}) AND (${C})`:C;const D=a.replace(/"/g,'""').trim();M.push(`"${D}"`)}const{result:x,totalCount:m}=await c.lightweightQuery({where:b,params:M,orderBy:s||"m.year DESC, m.imdbId",limit:o,offset:p,includeCount:w});return{result:x.map(Z),totalCount:m||0}},q=async e=>{if(!c.isReady.value)return[];if(!e||e.length===0)return[];n.value||(n.value=new Map);const a=e.filter(r=>!n.value.has(r));if(a.length===0)return e.map(r=>n.value.get(r)).filter(Boolean);try{return(await c.queryByIds(a)).map(Q).forEach(s=>{n.value.set(s.imdbId,s),l.value.has(s.imdbId)||l.value.set(s.imdbId,s)}),e.map(s=>n.value.get(s)).filter(Boolean)}catch(r){return window.console.error("[MovieStore] Failed to fetch movies by IDs:",r),[]}},ee=async e=>{if(n.value.has(e)){const a=n.value.get(e);if(a&&a.sources&&a.sources.length>0)return a}if(l.value.has(e)){const a=l.value.get(e);if(a&&a.sources&&a.sources.length>0)return a}u.value.movieDetails=!0;try{const a=await $fetch(`${E().app.baseURL}movies/${e}.json`);return a&&typeof a=="object"&&a.imdbId&&a.title?(n.value.set(e,a),a):void 0}catch(a){window.console.error(`[MovieStore] Failed to fetch movie details for ${e}:`,a);return}finally{u.value.movieDetails=!1}},te=async(e,a=8)=>{try{const r=await $fetch(`${E().app.baseURL}movies/${e}.json`);if(!r||!r.relatedMovies||r.relatedMovies.length===0)return[];if(c.isReady.value){const i=r.relatedMovies.map(o=>o.imdbId);return await q(i)}return r.relatedMovies.map(i=>({imdbId:i.imdbId,title:i.title,year:i.year,sources:[],lastUpdated:new Date().toISOString(),metadata:{imdbRating:i.imdbRating?.toString(),imdbVotes:i.imdbVotes?.toString(),Language:i.language}}))}catch(r){return window.console.error("[MovieStore] Failed to fetch related movies:",r),[]}},T=async e=>{if(!e||!e.trim())return Array.from(l.value.values());if(!c.isReady.value){const a=e.toLowerCase();return Array.from(l.value.values()).filter(r=>(Array.isArray(r.title)?r.title:[r.title]).some(s=>s.toLowerCase().includes(a)))}try{const a=e.replace(/"/g,'""').trim(),r=await c.query(`
        SELECT m.imdbId
        FROM fts_movies f
        JOIN movies m ON f.imdbId = m.imdbId
        WHERE fts_movies MATCH ?
        ORDER BY m.title ASC
      `,[`"${a}"`]),i=new Set(r.map(s=>s.imdbId));return Array.from(l.value.values()).filter(s=>i.has(s.imdbId))}catch(a){return window.console.error("[MovieStore] Search failed:",a),[]}},B=async()=>{if(!c.isReady.value){window.console.log("DB not ready, cannot fetch lightweight movies");return}f.value=!0;try{const e=[],a=[];if(t.value.minRating>0&&(a.push("m.imdbRating >= ?"),e.push(t.value.minRating)),t.value.minYear>0&&(a.push("m.year >= ?"),e.push(t.value.minYear)),t.value.maxYear&&t.value.maxYear>0&&(a.push("m.year <= ?"),e.push(t.value.maxYear)),t.value.minVotes>0&&(a.push("m.imdbVotes >= ?"),e.push(t.value.minVotes)),t.value.maxVotes&&t.value.maxVotes>0&&(a.push("m.imdbVotes <= ?"),e.push(t.value.maxVotes)),t.value.genres.length>0&&t.value.genres.forEach(w=>{a.push("m.genre LIKE ?"),e.push(`%${w}%`)}),t.value.countries.length>0&&t.value.countries.forEach(w=>{a.push("m.country LIKE ?"),e.push(`%${w}%`)}),t.value.sources.length>0){await L();return}let r="";const i=t.value.sort.field,s=t.value.sort.direction.toUpperCase();if(i==="relevance"&&t.value.searchQuery){await L();return}else i==="rating"?r=`m.imdbRating ${s}`:i==="year"?r=`m.year ${s}`:i==="title"?r=`m.title ${s}`:i==="votes"&&(r=`m.imdbVotes ${s}`);const{result:o,totalCount:p}=await c.lightweightQuery({where:a.join(" AND "),params:e,orderBy:r,includeCount:!0});g.value=o||[],p!==void 0&&(A.value=p)}catch(e){window.window.console.error("[MovieStore] Lightweight query failed:",e),g.value=[]}finally{f.value=!1}},L=async(e=!1)=>{if(!c.isReady.value){window.window.console.error("DB not ready, using JS filtering");const a=await T(t.value.searchQuery);y.value=k(a),A.value=y.value.length;return}e||(f.value=!0);try{const a=[],r=[];if(t.value.minRating>0&&(r.push("m.imdbRating >= ?"),a.push(t.value.minRating)),t.value.minYear>0&&(r.push("m.year >= ?"),a.push(t.value.minYear)),t.value.maxYear&&t.value.maxYear>0&&(r.push("m.year <= ?"),a.push(t.value.maxYear)),t.value.minVotes>0&&(r.push("m.imdbVotes >= ?"),a.push(t.value.minVotes)),t.value.maxVotes&&t.value.maxVotes>0&&(r.push("m.imdbVotes <= ?"),a.push(t.value.maxVotes)),t.value.sources.length>0){const m=[];t.value.sources.includes("archive.org")&&m.push("s.type = 'archive.org'");const C=t.value.sources.filter(D=>D!=="archive.org");C.length>0&&(m.push(`(s.type = 'youtube' AND c.name IN (${C.map(()=>"?").join(",")}))`),a.push(...C)),m.length>0&&r.push(`(${m.join(" OR ")})`)}t.value.genres.length>0&&t.value.genres.forEach(m=>{r.push("m.genre LIKE ?"),a.push(`%${m}%`)}),t.value.countries.length>0&&t.value.countries.forEach(m=>{r.push("m.country LIKE ?"),a.push(`%${m}%`)});let i="";const s=t.value.sort.field,o=t.value.sort.direction.toUpperCase();s==="relevance"&&t.value.searchQuery?i=`m.title ${o}`:s==="rating"?i=`m.imdbRating ${o}`:s==="year"?i=`m.year ${o}`:s==="title"?i=`m.title ${o}`:s==="votes"&&(i=`m.imdbVotes ${o}`);const p=50,w=t.value.currentPage*p,b=e?(t.value.currentPage-1)*p:0,{result:M,totalCount:x}=await N({searchQuery:t.value.searchQuery,where:r.join(" AND "),params:a,orderBy:i,limit:e?p:w,offset:b,includeCount:!0});e?(y.value=[...y.value,...M],g.value=[...g.value,...M.map(m=>({imdbId:m.imdbId,title:m.title,year:m.year||0}))]):(y.value=M,g.value=M.map(m=>({imdbId:m.imdbId,title:m.title,year:m.year||0}))),x!==void 0&&(A.value=x)}catch(a){window.window.console.error("[MovieStore] SQL filtering failed:",a),y.value=[]}finally{f.value=!1}},k=e=>{let a=[...e];a=j(a),t.value.sources.length>0&&(a=a.filter(i=>i.sources.some(s=>s.type==="archive.org"?t.value.sources.includes("archive.org"):s.type==="youtube"?t.value.sources.includes(s.channelName):!1))),t.value.minRating>0&&(a=a.filter(i=>parseFloat(i.metadata?.imdbRating||"0")>=t.value.minRating)),(t.value.minYear>0||t.value.maxYear&&t.value.maxYear>0)&&(a=a.filter(i=>{const s=i.year||0;return!(t.value.minYear>0&&s<t.value.minYear||t.value.maxYear&&t.value.maxYear>0&&s>t.value.maxYear)})),(t.value.minVotes>0||t.value.maxVotes&&t.value.maxVotes>0)&&(a=a.filter(i=>{const s=i.metadata?.imdbVotes,o=typeof s=="number"?s:parseInt(String(s||"0").replace(/,/g,""));return!(t.value.minVotes>0&&o<t.value.minVotes||t.value.maxVotes&&t.value.maxVotes>0&&o>t.value.maxVotes)})),t.value.genres.length>0&&(a=a.filter(i=>{const s=i.metadata?.Genre?.split(", ").map(o=>o.trim())||[];return t.value.genres.some(o=>s.includes(o))})),t.value.countries.length>0&&(a=a.filter(i=>{const s=i.metadata?.Country?.split(", ").map(o=>o.trim())||[];return t.value.countries.some(o=>s.includes(o))}));const r=V.find(i=>i.field===t.value.sort.field&&i.direction===t.value.sort.direction)||V[0];return r.field!=="relevance"&&(a=Be(a,r)),a},ae=e=>{t.value.sort={field:e.field,direction:e.direction},t.value.searchQuery!==""&&(t.value.previousSort=void 0)},re=e=>{const a=t.value.searchQuery==="",r=e==="";a&&!r?(t.value.previousSort={...t.value.sort},t.value.sort={field:"relevance",direction:"desc"}):!a&&r&&t.value.previousSort&&(t.value.sort={...t.value.previousSort},t.value.previousSort=void 0),t.value.searchQuery=e},ie=e=>{t.value.sources=t.value.sources.includes(e)?t.value.sources.filter(a=>a!==e):[...t.value.sources,e]},se=e=>{t.value.minRating=e},oe=e=>{t.value.minYear=e},le=e=>{t.value.maxYear=e},ne=e=>{t.value.minVotes=e},ue=e=>{t.value.maxVotes=e},ce=e=>{t.value.genres=t.value.genres.includes(e)?t.value.genres.filter(a=>a!==e):[...t.value.genres,e]},de=e=>{t.value.countries=t.value.countries.includes(e)?t.value.countries.filter(a=>a!==e):[...t.value.countries,e]},ve=()=>{t.value={...J}},fe=e=>{t.value.currentPage=e},me=e=>{t.value.lastScrollY=e},ge=e=>{const a=d.value.indexOf(e);a>-1?d.value.splice(a,1):d.value.push(e)},he=e=>{d.value.includes(e)||d.value.push(e)},ye=e=>d.value.includes(e),pe=e=>{if(e.sources.length===0)return;const a=e.sources.filter(r=>r.type==="archive.org");return a.length>0?[...a].sort((i,s)=>{const o="downloads"in i&&i.downloads||0;return("downloads"in s&&s.downloads||0)-o})[0]:e.sources[0]},U=async e=>{if(!e)return!1;if(h.value.has(e))return h.value.get(e);try{const r=(await fetch(P(e),{method:"HEAD"})).ok;return h.value.set(e,r),r}catch{return h.value.set(e,!1),!1}},be=async e=>{const a="/images/poster-placeholder.jpg";if(!e.imdbId)return a;if(await U(e.imdbId))return P(e.imdbId);const i=e.metadata?.Poster;return i&&i!=="N/A"?i:a},we=(e,a=!0)=>{const r="/images/poster-placeholder.jpg";if(!e.imdbId)return r;if(a)return P(e.imdbId);const i=e.metadata?.Poster;return i&&i!=="N/A"?i:r},Se=async(e,a,r,i="admin")=>{try{if((await $fetch("/api/admin/movie/update",{method:"POST",body:{movieId:e,qualityLabels:a,qualityNotes:r,qualityMarkedBy:i}})).success){const o=b=>{b.qualityLabels=a,b.qualityNotes=r,b.qualityMarkedBy=i,b.qualityMarkedAt=new Date().toISOString(),b.lastUpdated=new Date().toISOString()},p=l.value.get(e);p&&o(p);const w=n.value.get(e);return w&&o(w),!0}return!1}catch(s){return window.console.error("[MovieStore] Failed to mark movie quality:",s),!1}},Me=async e=>{try{if((await $fetch("/api/admin/movie/update",{method:"POST",body:{movieId:e,qualityLabels:[]}})).success){const r=o=>{delete o.qualityLabels,delete o.qualityNotes,delete o.qualityMarkedBy,delete o.qualityMarkedAt,o.lastUpdated=new Date().toISOString()},i=l.value.get(e);i&&r(i);const s=n.value.get(e);return s&&r(s),!0}return!1}catch(a){return window.console.error("[MovieStore] Failed to clear movie quality:",a),!1}},Ie=()=>Array.from(l.value.values()).filter(e=>(e.qualityLabels?.length||0)>0),j=e=>e.filter(a=>(a.qualityLabels?.length||0)===0),Re=Ve(R(()=>t.value.searchQuery),500);return $(()=>{const{currentPage:e,lastScrollY:a,searchQuery:r,...i}=t.value;return JSON.stringify({...i,searchQuery:Re.value})},()=>{t.value.currentPage=1,B()}),$(()=>t.value.currentPage,(e,a)=>{e>a&&L(!0)}),$(()=>c.isReady.value,e=>{const a=g.value?.length||0;e&&a===0&&B()},{immediate:!0}),{allMovies:S(l),movieDetailsCache:S(n),filters:S(t),isInitialLoading:S(v),isFiltering:S(f),isLoading:S(u),likedMovieIds:S(d),filteredAndSortedMovies:S(y),lightweightMovies:S(g),currentMovieList:Y,totalMovies:F,totalFiltered:S(A),likedCount:W,activeFiltersCount:z,hasActiveFilters:G,currentSortOption:K,loadFromFile:X,loadFromApi:O,fetchMovies:N,fetchMoviesByIds:q,getMovieById:ee,getRelatedMovies:te,searchMovies:T,mapRowToMovie:Q,setSort:ae,setSearchQuery:re,toggleSource:ie,setMinRating:se,setMinYear:oe,setMaxYear:le,setMinVotes:ne,setMaxVotes:ue,toggleGenre:ce,toggleCountry:de,resetFilters:ve,applyFilters:k,fetchFilteredMovies:L,fetchLightweightMovies:B,setCurrentPage:fe,setScrollY:me,toggleLike:ge,like:he,isLiked:ye,getPrimarySource:pe,posterExists:U,getPosterUrl:be,getPosterUrlSync:we,markMovieQuality:Se,clearMovieQuality:Me,getMarkedMovies:Ie,getQualityFilteredMovies:j}});export{Ee as u};
