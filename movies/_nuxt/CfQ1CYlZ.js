import{a3 as Ce,s as H,a7 as W,r as I,e as R,ar as Ve,n as E,as as S,at as z,W as Ae,X as P}from"./02OeVUp7.js";import{u as Le,g as $}from"./CZfkSF8C.js";const V=[{field:"relevance",direction:"desc",label:"Relevance"},{field:"year",direction:"desc",label:"Year (Newest)"},{field:"year",direction:"asc",label:"Year (Oldest)"},{field:"rating",direction:"desc",label:"Rating (High)"},{field:"rating",direction:"asc",label:"Rating (Low)"},{field:"title",direction:"asc",label:"Title (A-Z)"},{field:"title",direction:"desc",label:"Title (Z-A)"},{field:"votes",direction:"desc",label:"Most Popular"}];function xe(n,o){return[...n].sort((d,t)=>{const c=d.year||0,v=t.year||0;if(c===0&&v===0)return 0;if(c===0)return 1;if(v===0)return-1;if(c===v){const f=d.title,u=t.title,h=f.localeCompare(u);if(h!==0)return h;const g=d.imdbId||"",y=t.imdbId||"";return g.localeCompare(y)}return o==="asc"?c-v:v-c})}function Ye(n,o){return[...n].sort((d,t)=>{const c=parseFloat(d.metadata?.imdbRating||"0"),v=parseFloat(t.metadata?.imdbRating||"0");if(c===0&&v===0)return 0;if(c===0)return 1;if(v===0)return-1;if(c===v){const f=d.title,u=t.title,h=f.localeCompare(u);if(h!==0)return h;const g=d.imdbId||"",y=t.imdbId||"";return g.localeCompare(y)}return o==="asc"?c-v:v-c})}function Be(n,o){return[...n].sort((d,t)=>{const c=d.title.toLowerCase(),v=t.title.toLowerCase(),f=c.localeCompare(v);if(f!==0)return o==="asc"?f:-f;const u=d.imdbId||"",h=t.imdbId||"";return u.localeCompare(h)})}function De(n,o){return[...n].sort((d,t)=>{const c=d.metadata?.imdbVotes,v=t.metadata?.imdbVotes,f=typeof c=="number"?c:parseInt(String(c||"0").replace(/,/g,"")),u=typeof v=="number"?v:parseInt(String(v||"0").replace(/,/g,""));if(f===0&&u===0)return 0;if(f===0)return 1;if(u===0)return-1;if(f===u){const h=d.title,g=t.title,y=h.localeCompare(g);if(y!==0)return y;const Y=d.imdbId||"",B=t.imdbId||"";return Y.localeCompare(B)}return o==="asc"?f-u:u-f})}function Fe(n,o){switch(o.field){case"year":return xe(n,o.direction);case"rating":return Ye(n,o.direction);case"title":return Be(n,o.direction);case"votes":return De(n,o.direction);default:return n}}const G={sort:{field:"year",direction:"desc"},sources:[],minRating:0,minYear:0,maxYear:0,minVotes:0,maxVotes:0,genres:[],countries:[],searchQuery:"",currentPage:1,lastScrollY:0},$e=Ce("movie",()=>{const n=H(new Map),o=H(new Map),d=W("movies-deluxe-liked",[]),t=W("movies-deluxe-filters",G),c=I({movies:!1,movieDetails:!1,imdbFetch:!1}),v=I(!0),f=I(!1),u=Le(),h=I(new Map),g=I([]),y=I([]),Y=R(()=>g.value.length>0?g.value:Array.from(n.value.values()).filter(e=>e.year!==void 0).sort((e,a)=>(a.year||0)-(e.year||0)).map(e=>({imdbId:e.imdbId,title:e.title,year:e.year||0}))),B=R(()=>n.value.size),A=I(0),K=R(()=>d.value.length),J=R(()=>{let e=0;return t.value.sources.length>0&&e++,t.value.minRating>0&&e++,t.value.minYear>0&&e++,t.value.minVotes>0&&e++,t.value.genres.length>0&&e++,t.value.countries.length>0&&e++,e}),X=R(()=>t.value.sources.length>0||t.value.minRating>0||t.value.minYear>0||t.value.minVotes>0||t.value.genres.length>0||t.value.countries.length>0),Z=R(()=>{if(!t.value||!t.value.sort)return V[0];const e=t.value.sort;return V.find(i=>i.field===e.field&&i.direction===e.direction)||V[0]}),ee=e=>({imdbId:e.imdbId,title:e.title,year:e.year,lastUpdated:new Date().toISOString(),sources:[],metadata:{imdbRating:typeof e.imdbRating=="number"?e.imdbRating.toString():e.imdbRating?.toString(),imdbVotes:typeof e.imdbVotes=="number"?e.imdbVotes.toLocaleString():e.imdbVotes?.toString(),imdbID:e.imdbId,Language:e.language}}),Q=e=>{const a=[];if(e.primarySourceType){const i=e.primarySourceType;i==="youtube"&&e.primaryChannelName?a.push({type:"youtube",id:"",url:"",title:e.title,channelName:e.primaryChannelName,addedAt:e.lastUpdated}):i==="archive.org"&&a.push({type:"archive.org",id:"",url:"",title:e.title,addedAt:e.lastUpdated})}return{imdbId:e.imdbId,title:e.title,year:e.year,lastUpdated:e.lastUpdated,sources:a,metadata:{imdbRating:e.imdbRating?.toString(),imdbVotes:e.imdbVotes?.toLocaleString(),imdbID:e.imdbId,Genre:e.genre,Language:e.language,Country:e.country},verified:e.verified}},T=async()=>{c.value.movies=!0;try{await u.init(`${z().app.baseURL}data/movies.db`),v.value=!1}catch(e){window.console.error("Failed to initialize SQLite:",e);const{showToast:a}=Ae();a("Failed to load movie database. Please refresh the page to try again.","error",5e3)}finally{c.value.movies=!1,v.value=!1}},N=async e=>{if(!u.isReady.value)return{result:[],totalCount:0};const{searchQuery:a,where:i,params:r=[],orderBy:s,limit:l,offset:p,includeCount:w}=e;let b=i||"";const M=[...r];if(a?.trim()){const C="EXISTS (SELECT 1 FROM fts_movies f WHERE f.imdbId = m.imdbId AND fts_movies MATCH ?)";b=b?`(${b}) AND (${C})`:C;const F=a.replace(/"/g,'""').trim();M.push(`"${F}"`)}const{result:x,totalCount:m}=await u.lightweightQuery({where:b,params:M,orderBy:s||"m.year DESC, m.imdbId",limit:l,offset:p,includeCount:w});return{result:x.map(ee),totalCount:m||0}},q=async e=>{if(!e||e.length===0)return[];if(o.value||(o.value=new Map),e.filter(r=>!o.value.has(r)).length===0)return e.map(r=>o.value.get(r)).filter(Boolean);if(!u.isReady.value){v.value&&!c.value.movies&&T();let r=0;for(;!u.isReady.value&&r<100;)await new Promise(s=>setTimeout(s,100)),r++;if(!u.isReady.value)return window.console.error("[MovieStore] Database not ready after waiting"),[]}const i=e.filter(r=>!o.value.has(r));if(i.length===0)return e.map(r=>o.value.get(r)).filter(Boolean);try{return(await u.queryByIds(i)).map(Q).forEach(l=>{o.value.set(l.imdbId,l),n.value.has(l.imdbId)||n.value.set(l.imdbId,l)}),e.map(l=>o.value.get(l)).filter(Boolean)}catch(r){return window.console.error("[MovieStore] Failed to fetch movies by IDs:",r),[]}},O=async e=>{if(o.value.has(e)){const a=o.value.get(e);if(a&&a.sources&&a.sources.length>0&&a.sources[0]?.id)return a}if(n.value.has(e)){const a=n.value.get(e);if(a&&a.sources&&a.sources.length>0&&a.sources[0]?.id)return a}c.value.movieDetails=!0;try{const a=await $fetch(`${z().app.baseURL}movies/${e}.json`);return a&&typeof a=="object"&&a.imdbId&&a.title?(o.value.set(e,a),a):void 0}catch(a){window.console.error(`[MovieStore] Failed to fetch movie details for ${e}:`,a);return}finally{c.value.movieDetails=!1}},te=async(e,a=8)=>{try{let i;if(o.value.has(e)){const r=o.value.get(e);r&&r.sources&&r.sources.length>0&&(i=r)}if(i||(i=await O(e)),!i||!i.relatedMovies||i.relatedMovies.length===0)return[];if(u.isReady.value){const r=i.relatedMovies.map(l=>l.imdbId);return await q(r)}return i.relatedMovies.map(r=>({imdbId:r.imdbId,title:r.title,year:r.year,sources:[],lastUpdated:new Date().toISOString(),metadata:{imdbRating:r.imdbRating?.toString(),imdbVotes:r.imdbVotes?.toString(),Language:r.language}}))}catch(i){return window.console.error("[MovieStore] Failed to fetch related movies:",i),[]}},U=async e=>{if(!e||!e.trim())return Array.from(n.value.values());if(!u.isReady.value){const a=e.toLowerCase();return Array.from(n.value.values()).filter(i=>(Array.isArray(i.title)?i.title:[i.title]).some(s=>s.toLowerCase().includes(a)))}try{const a=e.replace(/"/g,'""').trim(),i=await u.query(`
        SELECT m.imdbId
        FROM fts_movies f
        JOIN movies m ON f.imdbId = m.imdbId
        WHERE fts_movies MATCH ?
        ORDER BY m.title ASC
      `,[`"${a}"`]),r=new Set(i.map(s=>s.imdbId));return Array.from(n.value.values()).filter(s=>r.has(s.imdbId))}catch(a){return window.console.error("[MovieStore] Search failed:",a),[]}},D=async()=>{if(!u.isReady.value){window.console.log("DB not ready, cannot fetch lightweight movies");return}f.value=!0;try{const e=[],a=[];if(t.value.minRating>0&&(a.push("m.imdbRating >= ?"),e.push(t.value.minRating)),t.value.minYear>0&&(a.push("m.year >= ?"),e.push(t.value.minYear)),t.value.maxYear&&t.value.maxYear>0&&(a.push("m.year <= ?"),e.push(t.value.maxYear)),t.value.minVotes>0&&(a.push("m.imdbVotes >= ?"),e.push(t.value.minVotes)),t.value.maxVotes&&t.value.maxVotes>0&&(a.push("m.imdbVotes <= ?"),e.push(t.value.maxVotes)),t.value.genres.length>0&&t.value.genres.forEach(w=>{a.push("m.genre LIKE ?"),e.push(`%${w}%`)}),t.value.countries.length>0&&t.value.countries.forEach(w=>{a.push("m.country LIKE ?"),e.push(`%${w}%`)}),t.value.sources.length>0){await L();return}let i="";const r=t.value.sort.field,s=t.value.sort.direction.toUpperCase();if(r==="relevance"&&t.value.searchQuery){await L();return}else r==="rating"?i=`m.imdbRating ${s}`:r==="year"?i=`m.year ${s}`:r==="title"?i=`m.title ${s}`:r==="votes"&&(i=`m.imdbVotes ${s}`);const{result:l,totalCount:p}=await u.lightweightQuery({where:a.join(" AND "),params:e,orderBy:i,includeCount:!0});g.value=l||[],p!==void 0&&(A.value=p)}catch(e){window.window.console.error("[MovieStore] Lightweight query failed:",e),g.value=[]}finally{f.value=!1}},L=async(e=!1)=>{if(!u.isReady.value){window.window.console.error("DB not ready, using JS filtering");const a=await U(t.value.searchQuery);y.value=k(a),A.value=y.value.length;return}e||(f.value=!0);try{const a=[],i=[];if(t.value.minRating>0&&(i.push("m.imdbRating >= ?"),a.push(t.value.minRating)),t.value.minYear>0&&(i.push("m.year >= ?"),a.push(t.value.minYear)),t.value.maxYear&&t.value.maxYear>0&&(i.push("m.year <= ?"),a.push(t.value.maxYear)),t.value.minVotes>0&&(i.push("m.imdbVotes >= ?"),a.push(t.value.minVotes)),t.value.maxVotes&&t.value.maxVotes>0&&(i.push("m.imdbVotes <= ?"),a.push(t.value.maxVotes)),t.value.sources.length>0){const m=[];t.value.sources.includes("archive.org")&&m.push("s.type = 'archive.org'");const C=t.value.sources.filter(F=>F!=="archive.org");C.length>0&&(m.push(`(s.type = 'youtube' AND c.name IN (${C.map(()=>"?").join(",")}))`),a.push(...C)),m.length>0&&i.push(`(${m.join(" OR ")})`)}t.value.genres.length>0&&t.value.genres.forEach(m=>{i.push("m.genre LIKE ?"),a.push(`%${m}%`)}),t.value.countries.length>0&&t.value.countries.forEach(m=>{i.push("m.country LIKE ?"),a.push(`%${m}%`)});let r="";const s=t.value.sort.field,l=t.value.sort.direction.toUpperCase();s==="relevance"&&t.value.searchQuery?r=`m.title ${l}`:s==="rating"?r=`m.imdbRating ${l}`:s==="year"?r=`m.year ${l}`:s==="title"?r=`m.title ${l}`:s==="votes"&&(r=`m.imdbVotes ${l}`);const p=50,w=t.value.currentPage*p,b=e?(t.value.currentPage-1)*p:0,{result:M,totalCount:x}=await N({searchQuery:t.value.searchQuery,where:i.join(" AND "),params:a,orderBy:r,limit:e?p:w,offset:b,includeCount:!0});e?(y.value=[...y.value,...M],g.value=[...g.value,...M.map(m=>({imdbId:m.imdbId,title:m.title,year:m.year||0}))]):(y.value=M,g.value=M.map(m=>({imdbId:m.imdbId,title:m.title,year:m.year||0}))),x!==void 0&&(A.value=x)}catch(a){window.window.console.error("[MovieStore] SQL filtering failed:",a),y.value=[]}finally{f.value=!1}},k=e=>{let a=[...e];a=_(a),t.value.sources.length>0&&(a=a.filter(r=>r.sources.some(s=>s.type==="archive.org"?t.value.sources.includes("archive.org"):s.type==="youtube"?t.value.sources.includes(s.channelName):!1))),t.value.minRating>0&&(a=a.filter(r=>parseFloat(r.metadata?.imdbRating||"0")>=t.value.minRating)),(t.value.minYear>0||t.value.maxYear&&t.value.maxYear>0)&&(a=a.filter(r=>{const s=r.year||0;return!(t.value.minYear>0&&s<t.value.minYear||t.value.maxYear&&t.value.maxYear>0&&s>t.value.maxYear)})),(t.value.minVotes>0||t.value.maxVotes&&t.value.maxVotes>0)&&(a=a.filter(r=>{const s=r.metadata?.imdbVotes,l=typeof s=="number"?s:parseInt(String(s||"0").replace(/,/g,""));return!(t.value.minVotes>0&&l<t.value.minVotes||t.value.maxVotes&&t.value.maxVotes>0&&l>t.value.maxVotes)})),t.value.genres.length>0&&(a=a.filter(r=>{const s=r.metadata?.Genre?.split(", ").map(l=>l.trim())||[];return t.value.genres.some(l=>s.includes(l))})),t.value.countries.length>0&&(a=a.filter(r=>{const s=r.metadata?.Country?.split(", ").map(l=>l.trim())||[];return t.value.countries.some(l=>s.includes(l))}));const i=V.find(r=>r.field===t.value.sort.field&&r.direction===t.value.sort.direction)||V[0];return i.field!=="relevance"&&(a=Fe(a,i)),a},ae=e=>{t.value.sort={field:e.field,direction:e.direction},t.value.searchQuery!==""&&(t.value.previousSort=void 0)},re=e=>{const a=t.value.searchQuery==="",i=e==="";a&&!i?(t.value.previousSort={...t.value.sort},t.value.sort={field:"relevance",direction:"desc"}):!a&&i&&t.value.previousSort&&(t.value.sort={...t.value.previousSort},t.value.previousSort=void 0),t.value.searchQuery=e},ie=e=>{t.value.sources=t.value.sources.includes(e)?t.value.sources.filter(a=>a!==e):[...t.value.sources,e]},se=e=>{t.value.minRating=e},le=e=>{t.value.minYear=e},oe=e=>{t.value.maxYear=e},ne=e=>{t.value.minVotes=e},ue=e=>{t.value.maxVotes=e},ce=e=>{t.value.genres=t.value.genres.includes(e)?t.value.genres.filter(a=>a!==e):[...t.value.genres,e]},de=e=>{t.value.countries=t.value.countries.includes(e)?t.value.countries.filter(a=>a!==e):[...t.value.countries,e]},ve=()=>{t.value={...G}},fe=e=>{t.value.currentPage=e},me=e=>{t.value.lastScrollY=e},ge=e=>{const a=d.value.indexOf(e);a>-1?d.value.splice(a,1):d.value.push(e)},he=e=>{d.value.includes(e)||d.value.push(e)},ye=e=>d.value.includes(e),pe=e=>{if(e.sources.length===0)return;const a=e.sources.filter(i=>i.type==="archive.org");return a.length>0?[...a].sort((r,s)=>{const l="downloads"in r&&r.downloads||0;return("downloads"in s&&s.downloads||0)-l})[0]:e.sources[0]},j=async e=>{if(!e)return!1;if(h.value.has(e))return h.value.get(e);try{const i=(await fetch($(e),{method:"HEAD"})).ok;return h.value.set(e,i),i}catch{return h.value.set(e,!1),!1}},be=async e=>{const a="/images/poster-placeholder.jpg";if(!e.imdbId)return a;if(await j(e.imdbId))return $(e.imdbId);const r=e.metadata?.Poster;return r&&r!=="N/A"?r:a},we=(e,a=!0)=>{const i="/images/poster-placeholder.jpg";if(!e.imdbId)return i;if(a)return $(e.imdbId);const r=e.metadata?.Poster;return r&&r!=="N/A"?r:i},Se=async(e,a,i,r="admin")=>{try{if((await $fetch("/api/admin/movie/update",{method:"POST",body:{movieId:e,qualityLabels:a,qualityNotes:i,qualityMarkedBy:r}})).success){const l=b=>{b.qualityLabels=a,b.qualityNotes=i,b.qualityMarkedBy=r,b.qualityMarkedAt=new Date().toISOString(),b.lastUpdated=new Date().toISOString()},p=n.value.get(e);p&&l(p);const w=o.value.get(e);return w&&l(w),!0}return!1}catch(s){return window.console.error("[MovieStore] Failed to mark movie quality:",s),!1}},Me=async e=>{try{if((await $fetch("/api/admin/movie/update",{method:"POST",body:{movieId:e,qualityLabels:[]}})).success){const i=l=>{delete l.qualityLabels,delete l.qualityNotes,delete l.qualityMarkedBy,delete l.qualityMarkedAt,l.lastUpdated=new Date().toISOString()},r=n.value.get(e);r&&i(r);const s=o.value.get(e);return s&&i(s),!0}return!1}catch(a){return window.console.error("[MovieStore] Failed to clear movie quality:",a),!1}},Ie=()=>Array.from(n.value.values()).filter(e=>(e.qualityLabels?.length||0)>0),_=e=>e.filter(a=>(a.qualityLabels?.length||0)===0),Re=Ve(R(()=>t.value.searchQuery),500);return E(()=>{const{currentPage:e,lastScrollY:a,searchQuery:i,...r}=t.value;return JSON.stringify({...r,searchQuery:Re.value})},()=>{P().path==="/search"&&(t.value.currentPage=1,D())}),E(()=>t.value.currentPage,(e,a)=>{P().path==="/search"&&e>a&&L(!0)}),E(()=>u.isReady.value,e=>{if(P().path!=="/search")return;const a=g.value?.length||0;e&&a===0&&D()},{immediate:!0}),{allMovies:S(n),movieDetailsCache:S(o),filters:S(t),isInitialLoading:S(v),isFiltering:S(f),isLoading:S(c),likedMovieIds:S(d),filteredAndSortedMovies:S(y),lightweightMovies:S(g),currentMovieList:Y,totalMovies:B,totalFiltered:S(A),likedCount:K,activeFiltersCount:J,hasActiveFilters:X,currentSortOption:Z,loadFromFile:T,fetchMovies:N,fetchMoviesByIds:q,getMovieById:O,getRelatedMovies:te,searchMovies:U,mapRowToMovie:Q,setSort:ae,setSearchQuery:re,toggleSource:ie,setMinRating:se,setMinYear:le,setMaxYear:oe,setMinVotes:ne,setMaxVotes:ue,toggleGenre:ce,toggleCountry:de,resetFilters:ve,applyFilters:k,fetchFilteredMovies:L,fetchLightweightMovies:D,setCurrentPage:fe,setScrollY:me,toggleLike:ge,like:he,isLiked:ye,getPrimarySource:pe,posterExists:j,getPosterUrl:be,getPosterUrlSync:we,markMovieQuality:Se,clearMovieQuality:Me,getMarkedMovies:Ie,getQualityFilteredMovies:_}});export{$e as u};
